<div id="p5-container"></div>
<script>
    import p5 from "p5";

    const sketch = (p: p5) => {
        let textString = "044dFNnootu";
        const targetString = "404 Not Found";
        let xPos = 0;
        let yPos = 0;
        let conveyorY = 0;
        let state = "ENTER"; // ENTER, SHUFFLE, IDLE, EXIT
        let shuffleTimer = 0;
        let shuffleDuration = 60; // Frames for shuffle

        /** @type {number} */
        let fontSize = 64; // Base size, will scale

        // Colors
        let primaryColor = "#000000";
        let accentColor = "#000000";
        let bgColor = "#ffffff";

        /** @type {() => void} */
        p.setup = () => {
            const container = document.getElementById("p5-container");
            if (!container) return;

            const w = container.clientWidth;
            // Height based on font size + padding
            const h = 200;
            p.createCanvas(w, h).parent(container);

            // Get styles from CSS variables
            const style = getComputedStyle(document.body);
            primaryColor = style.getPropertyValue("--color-primary").trim();
            accentColor = style.getPropertyValue("--color-accent").trim();
            bgColor = "#ffffff";

            p.textFont("LINE Seed JP");
            p.textStyle(p.BOLD); // Approximating 800 weight with BOLD
            p.textAlign(p.CENTER, p.CENTER);

            resetAnimation();
        };

        function resetAnimation() {
            textString = "044dFNnootu";
            state = "ENTER";
            xPos = p.width + 200; // Start off-screen right
            conveyorY = p.height / 2 + 40;
            yPos = p.height / 2 - 10;
        }

        /** @type {() => void} */
        p.windowResized = () => {
            const container = document.getElementById("p5-container");
            if (container) {
                p.resizeCanvas(container.clientWidth, 200);
                if (state === "IDLE") {
                    xPos = p.width / 2;
                }
            }
        };

        const conveyorSpeed = 5; // Slightly faster
        let conveyorPosition = 0; // Track position manually to allow pausing

        /** @type {() => void} */
        p.draw = () => {
            p.background(bgColor);

            // Update conveyor position only when moving
            if (state === "ENTER" || state === "EXIT") {
                conveyorPosition -= conveyorSpeed;
            }

            // Draw Conveyor Belt
            p.noStroke();
            p.fill(accentColor);
            p.rect(0, conveyorY, p.width, 10);

            // Draw Moving Parts on Conveyor (simple dashes)
            // Move from right to left (decreasing x) to match text direction
            p.fill(255);
            let dashSpacing = 50;
            // Use manual position
            let offset = conveyorPosition % dashSpacing;
            for (
                let i = -dashSpacing;
                i < p.width + dashSpacing;
                i += dashSpacing
            ) {
                p.rect(i + offset, conveyorY + 2, 20, 6);
            }

            // Draw Text
            p.fill(primaryColor);
            p.textSize(calculateFontSize());
            p.text(textString, xPos, yPos);

            // Logic
            if (state === "ENTER") {
                // Move from right to center at constant speed
                // Target is center
                if (xPos > p.width / 2) {
                    xPos -= conveyorSpeed;

                    // Snap to center and switch state
                    if (xPos <= p.width / 2) {
                        xPos = p.width / 2;
                        state = "SHUFFLE";
                        shuffleTimer = 0;
                    }
                } else {
                    // In case it started left (resize logic) or overshot
                    xPos = p.width / 2;
                    state = "SHUFFLE";
                }
            } else if (state === "SHUFFLE") {
                shuffleTimer++;
                // Shuffle logic: Randomize chars until they match target
                if (shuffleTimer % 5 === 0) {
                    textString = shuffleText(
                        targetString,
                        shuffleTimer / shuffleDuration,
                    );
                }

                if (shuffleTimer > shuffleDuration) {
                    textString = targetString;
                    state = "IDLE";
                }
            } else if (state === "EXIT") {
                // Move out to left at same constant speed
                xPos -= conveyorSpeed;

                // Reset when fully off-screen
                if (xPos < -300) {
                    resetAnimation();
                }
            }
        };

        /** @type {() => void} */
        p.mousePressed = () => {
            // Check if mouse is over canvas
            if (
                p.mouseX > 0 &&
                p.mouseX < p.width &&
                p.mouseY > 0 &&
                p.mouseY < p.height
            ) {
                if (state === "IDLE") {
                    state = "EXIT";
                }
            }
        };

        /** @returns {number} */
        function calculateFontSize() {
            // Responsive font size
            return Math.min(64, p.width / 10);
        }

        /**
         * @param {string} target
         * @param {number} progress
         * @returns {string}
         */
        function shuffleText(target: string, progress: number) {
            let result = "";
            // Use only characters from "044dFNnootu" + space
            const chars = "04dFNnotu ";
            for (let i = 0; i < target.length; i++) {
                if (Math.random() < progress || target[i] === " ") {
                    result += target[i];
                } else {
                    result += chars.charAt(
                        Math.floor(Math.random() * chars.length),
                    );
                }
            }
            return result;
        }
    };

    new p5(sketch);
</script>

<style>
    #p5-container {
        width: 100%;
        height: 200px;
        margin: 0 auto;
        cursor: pointer;
        overflow: hidden;
    }
</style>
